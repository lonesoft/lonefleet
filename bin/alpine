#!/usr/bin/env bash

set -euo pipefail

. $(dirname "$0")/helpers
. parse_parameters

function can-connect-root(){
  test_server_online $INSTANCE_HOSTNAME_ALPINE || return 1
  reset_known_hosts $INSTANCE_HOSTNAME_ALPINE
  can-connect root
}

function _post-installation(){
  export INSTANCE_ADDRESS=$INSTANCE_HOSTNAME_ALPINE
  can-connect-root || return 0
  deploy root-file fleet/alpine/bin/post-installation
  wait_server_status offline $INSTANCE_HOSTNAME_ALPINE
  wait_server_status online $INSTANCE_HOSTNAME
  reset_known_hosts $INSTANCE_HOSTNAME
}

function _add-volumes(){
  deploy env VOLUME_NAME=/dev/sdb \
          +env VOLUME_MOUNT=/mnt/data \
          +file fleet/alpine/bin/add-disk
  deploy env VOLUME_NAME=/dev/sdc \
          +env VOLUME_MOUNT=/mnt/mass \
          +file fleet/alpine/bin/add-disk
}

function main(){
  [[ ${PROJECT_PATH:-undefined} == "undefined" ]] && export PROJECT_PATH=$(dirname $(dirname "$0"))
  cd $PROJECT_PATH

  local definitions=()
  definitions+=("bash:$(basename $BASH_SOURCE)")

  definitions+=("command:post-installation:performs post installation")
  definitions+=("command:add-volumes:add data and mass volumes")

  parse_parameters "${definitions[@]}" "$@" #--parse-parameters-dump #--parse-parameters-debug
}

main "$@"
