#!/usr/bin/env bash

set -euo pipefail

function reset_known_hosts(){
  ssh-keygen -f ~/.ssh/known_hosts -R $INSTANCE_HOSTNAME
  ssh-keygen -F $INSTANCE_HOSTNAME > /dev/null && return
  ssh-keyscan -H -p 22 -t ecdsa $INSTANCE_HOSTNAME >> ~/.ssh/known_hosts
}

function post_installation(){
  deploy root-file fleet/alpine/bin/post-installation
}

function add_disks(){
  deploy env VOLUME_NAME=/dev/sdb \
          +env VOLUME_MOUNT=/mnt/data \
          +file fleet/alpine/bin/add-disk
  deploy env VOLUME_NAME=/dev/sdc \
          +env VOLUME_MOUNT=/mnt/mass \
          +file fleet/alpine/bin/add-disk
}

function reboot(){
  deploy run sudo reboot
}

function main(){
  [[ ! -z $PROJECT_PATH ]] && cd $PROJECT_PATH
  . dotenv ""
  reset_known_hosts
  post_installation
  add_disks
  reboot
}

main "$@"
