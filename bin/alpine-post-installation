#!/usr/bin/env bash

set -euo pipefail

function app_to_known_hosts(){
  ssh-keygen -F $INSTANCE_HOSTNAME > /dev/null && return
  ssh-keyscan -H -p 22 -t ecdsa $INSTANCE_HOSTNAME >> ~/.ssh/known_hosts
}

function remove_from_known_hosts(){
  ssh-keygen -f ~/.ssh/known_hosts -R $INSTANCE_HOSTNAME
}

function main(){
  [[ ! -z $PROJECT_PATH ]] && cd $PROJECT_PATH
  . dotenv ""

  remove_from_known_hosts
  app_to_known_hosts
  deploy deploy alpine/alpine-post-installation || :
}

main "$@"
